"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[226],{9226:function(e,r,t){t.d(r,{Z:function(){return u}});var a=t(5893),s=t(7294),n=t(9355),l=t(751),i=t(5130);let d=e=>{let{messages:r,currentUserUid:t}=e,n=(0,s.useRef)(null),l=()=>{var e;null===(e=n.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})};if((0,s.useEffect)(()=>{l()},[r]),!r||0===r.length)return(0,a.jsx)("div",{className:"flex-grow p-4 overflow-y-auto flex justify-center items-center bg-neutral-light dark:bg-neutral-dark",children:(0,a.jsx)("p",{className:"text-neutral-medium dark:text-neutral-light italic",children:"No messages yet. Start the conversation!"})});let i=e=>{if(!e)return"";let r="number"==typeof e?new Date(e):e.toDate?e.toDate():new Date(e);return r.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!0})};return(0,a.jsxs)("div",{className:"flex-grow p-4 overflow-y-auto space-y-3 bg-neutral-light dark:bg-neutral-dark",children:[" ",r.map(e=>{if(!e||!e.id)return console.warn("Invalid message object:",e),null;let r=e.senderId===t;return(0,a.jsx)("div",{className:"flex ".concat(r?"justify-end":"justify-start"),children:(0,a.jsxs)("div",{className:"max-w-xs sm:max-w-sm md:max-w-md px-3 py-2 rounded-lg shadow-md ".concat(r?"bg-primary text-primary-darker dark:bg-primary-darker dark:text-white":"bg-neutral-light border border-neutral-medium/40 text-neutral-dark dark:bg-neutral-medium dark:text-neutral-light dark:border-neutral-dark"),children:[(0,a.jsx)("p",{className:"text-sm break-words",children:e.text})," ",e.timestamp&&(0,a.jsx)("p",{className:"text-xs mt-1 ".concat(r?"text-primary-darker opacity-70 dark:text-white dark:opacity-70":"text-neutral-medium opacity-70 dark:text-neutral-light dark:opacity-70"," text-right"),children:i(e.timestamp)})]})},e.id)}),(0,a.jsx)("div",{ref:n})]})},o=e=>{let{chatId:r,currentUserUid:t,chatMetadata:n,onSendMessage:l}=e,[i,d]=(0,s.useState)(""),[o,c]=(0,s.useState)(!1),[u,m]=(0,s.useState)(""),h=async e=>{if(e.preventDefault(),!i.trim()){m("Message cannot be empty.");return}if(/\b[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}\b/i.test(i)){m("Sharing email addresses is not allowed.");return}if(/\b\(?\d{3}\)?[-.\s]?\d{3}[-.\s]?\d{4}\b/i.test(i)){m("Sharing phone numbers is not allowed.");return}if(!n){m("Chat information is not available. Cannot send message.");return}if(n.orderCompletedAt&&Date.now()>n.orderCompletedAt+1728e5){m("Messaging is closed for this order (2 days after completion).");return}if(c(!0),m(""),!n||!n.buyerId||!n.vendorId){m("Chat metadata is incomplete. Cannot determine recipient."),c(!1);return}let r=n.buyerId===t?n.vendorId:n.buyerId;if(r===t){m("Recipient cannot be the same as the sender."),c(!1);return}let a={senderId:t,recipientId:r,text:i.trim()};try{if(!l){m("Cannot send message: Send handler is missing."),c(!1);return}await l(a),d("")}catch(e){console.error("Error sending message via onSendMessage:",e),m(e.message||"Failed to send message. Please try again.")}finally{c(!1)}};return(0,a.jsxs)("form",{onSubmit:h,className:"p-3 border-t border-neutral-medium/30 dark:border-neutral-medium bg-neutral-light dark:bg-neutral-dark",children:[" ",u&&(0,a.jsx)("p",{className:"text-red-700 dark:text-error text-xs mb-2 px-1",children:u})," ",(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,a.jsx)("input",{type:"text",value:i,onChange:e=>{d(e.target.value),u&&m("")},placeholder:"Type your message...",className:"flex-grow w-full px-3 py-2 border border-neutral-medium/50 dark:border-neutral-medium rounded-lg shadow-sm bg-neutral-light dark:bg-neutral-dark text-neutral-dark dark:text-neutral-light placeholder-neutral-medium dark:placeholder-neutral-light focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent disabled:bg-neutral-light/70 dark:disabled:bg-neutral-dark/70",disabled:o,onKeyPress:e=>{"Enter"!==e.key||e.shiftKey||h(e)}}),(0,a.jsx)("button",{type:"submit",disabled:o||!i.trim(),className:"inline-flex items-center justify-center px-4 py-2 bg-primary hover:bg-primary-darker text-primary-darker dark:text-white dark:bg-primary-darker dark:hover:bg-primary font-semibold rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 disabled:opacity-60 disabled:cursor-not-allowed",children:o?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("svg",{className:"animate-spin -ml-1 mr-2 h-5 w-5 text-primary-darker dark:text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[(0,a.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,a.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Sending..."]}):"Send"})]})]})},c=e=>{let{chatId:r,currentUserUid:t,onClose:c,isPageDisplay:u=!1}=e,[m,h]=(0,s.useState)([]),[g,x]=(0,s.useState)(null),[b,f]=(0,s.useState)(""),[p,k]=(0,s.useState)(!0),[y,v]=(0,s.useState)(!0),[w,j]=(0,s.useState)(!0),[N,C]=(0,s.useState)("Chat"),[E,I]=(0,s.useState)("");(0,s.useEffect)(()=>{let e;if(!r||!t){f("Missing chat ID or user information."),h([]),x(null),k(!1),v(!1),j(!1);return}f(""),h([]),x(null),C("Chat"),k(!0),v(!0),j(!0);try{e=(0,n.iH)(l.Fs,"chats/".concat(r,"/metadata"))}catch(e){console.error("Error creating Firebase references:",e),f("Invalid chat ID format or issue creating chat reference."),k(!1),v(!1),v(!1),j(!1);return}let a=(0,n.jM)(e,e=>{if(e.exists()){let r=e.val();x(r),r.buyerId&&r.vendorId&&C(t===r.buyerId?"Chat with Vendor":"Chat with Buyer")}else f("Chat details not found or access denied."),x(null);v(!1)},e=>{console.error("Error fetching chat metadata:",e),f("Failed to load chat details."),x(null),v(!1)}),s=(0,i._U)(r,(e,r)=>{r?(console.error("Error fetching messages via chatApi:",r),f("Failed to load messages."),h([])):h(e),j(!1)});return()=>{e&&(0,n.S1)(e,"value",a),s&&"function"==typeof s&&s()}},[r,t]),(0,s.useEffect)(()=>{y||w||k(!1)},[y,w]),(0,s.useEffect)(()=>{if(!m||0===m.length||!t||!r||!g)return;let e=g.buyerId===t,a=g.vendorId===t;(e||a)&&m.forEach(e=>{e.recipientId!==t||e.isRead||(0,i.zJ)(r,e.id,t).then(()=>{}).catch(r=>{console.error("Failed to mark message ".concat(e.id," as read via chatApi:"),r)})})},[m,t,r,g]);let S=async e=>{if(!r)throw console.error("ChatWindow: chatId is missing, cannot send message."),I("Chat ID is missing. Cannot send message."),Error("Chat ID is missing.");I("");try{await (0,i.Hz)(r,e.text,e.senderId,e.recipientId)}catch(e){throw console.error("Error sending message from ChatWindow:",e),I(e.message||"Failed to send message."),e}},M=(0,s.useCallback)(()=>!!g&&!!g.orderCompletedAt&&Date.now()>g.orderCompletedAt+1728e5,[g]),F=e=>{let{children:r,titleOverride:t,headerBg:s="bg-gray-700"}=e;return(0,a.jsxs)("div",{className:u?"w-full h-full bg-neutral-light dark:bg-neutral-dark flex flex-col border border-neutral-medium/30 dark:border-neutral-medium":"fixed bottom-4 right-4 w-96 h-[500px] bg-neutral-light dark:bg-neutral-dark shadow-xl rounded-lg flex flex-col border border-neutral-medium/30 dark:border-neutral-medium z-50",children:[(0,a.jsxs)("header",{className:"".concat("bg-red-600"===s?"bg-red-700 text-white":"bg-neutral-dark text-neutral-light"," p-3 flex justify-between items-center ").concat("rounded-t-lg"),children:[(0,a.jsx)("h2",{className:"font-semibold text-lg",children:t||N}),(!u||u&&c)&&c&&(0,a.jsx)("button",{onClick:c,className:"text-neutral-medium hover:text-neutral-light text-2xl leading-none focus:outline-none",children:"\xd7"})]}),r]})};return r&&t?p?(0,a.jsx)(F,{titleOverride:"Loading Chat...",children:(0,a.jsxs)("div",{className:"flex-grow flex flex-col justify-center items-center p-4 bg-neutral-light dark:bg-neutral-dark",children:[(0,a.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary mb-3"}),(0,a.jsx)("p",{className:"text-neutral-dark dark:text-neutral-light",children:"Loading chat..."})]})}):b&&!g?(0,a.jsx)(F,{titleOverride:"Chat Error",headerBg:"bg-red-600",children:(0,a.jsxs)("div",{className:"flex-grow flex flex-col justify-center items-center p-4 bg-neutral-light dark:bg-neutral-dark text-center",children:[(0,a.jsx)("p",{className:"text-red-700 dark:text-error",children:b}),(0,a.jsx)("p",{className:"text-sm text-neutral-medium dark:text-neutral-light mt-1",children:"Please try again or select a different chat."}),c&&!u&&(0,a.jsx)("button",{onClick:c,className:"mt-4 px-4 py-2 bg-primary text-primary-darker dark:bg-primary-darker dark:text-white rounded hover:bg-primary-darker dark:hover:bg-primary",children:"Close"})]})}):g||p||b?(0,a.jsxs)(F,{children:[(0,a.jsx)(d,{messages:m,currentUserUid:t}),b&&g&&w&&(0,a.jsxs)("div",{className:"p-2 text-center text-xs text-red-700 dark:text-error bg-error/20 dark:bg-red-800/30 border-t border-neutral-medium/30 dark:border-neutral-medium",children:["Error loading messages: ",b]}),g&&(M()?(0,a.jsx)("div",{className:"p-3 text-center text-sm text-amber-700 dark:text-warning bg-warning/20 dark:bg-amber-800/30 border-t border-amber-300 dark:border-amber-700",children:"This chat is read-only. Messaging is closed for this order (2 days after completion)."}):(0,a.jsx)(o,{chatId:r,currentUserUid:t,chatMetadata:g,onSendMessage:S})),E&&(0,a.jsxs)("div",{className:"p-2 text-center text-xs text-red-700 dark:text-error bg-error/20 dark:bg-red-800/30 border-t border-neutral-medium/30 dark:border-neutral-medium",children:["Error sending: ",E]})]}):(0,a.jsx)(F,{titleOverride:"Chat Unavailable",children:(0,a.jsxs)("div",{className:"flex-grow flex flex-col justify-center items-center p-4 bg-neutral-light dark:bg-neutral-dark text-center",children:[(0,a.jsx)("p",{className:"text-neutral-dark dark:text-neutral-light",children:"Chat data is not available for this selection."}),c&&!u&&(0,a.jsx)("button",{onClick:c,className:"mt-4 px-4 py-2 bg-primary text-primary-darker dark:bg-primary-darker dark:text-white rounded hover:bg-primary-darker dark:hover:bg-primary",children:"Close"})]})}):(0,a.jsx)(F,{titleOverride:"Chat Window",children:(0,a.jsxs)("div",{className:"flex-grow flex flex-col justify-center items-center p-4 bg-neutral-light dark:bg-neutral-dark",children:[(0,a.jsx)("p",{className:"text-neutral-dark dark:text-neutral-light text-center",children:"No chat selected. Please select a chat to view messages."}),c&&!u&&(0,a.jsx)("button",{onClick:c,className:"mt-4 px-4 py-2 bg-neutral-medium/30 text-neutral-dark dark:bg-neutral-medium dark:text-neutral-light rounded hover:bg-neutral-medium/50 dark:hover:bg-neutral-medium/70",children:"Close"})]})})};var u=c},5130:function(e,r,t){t.d(r,{EG:function(){return n},Hz:function(){return l},_U:function(){return i},v$:function(){return o},zJ:function(){return d}});var a=t(9355),s=t(751);let n=(e,r)=>{if(!e)return r(Error("User ID is required to fetch conversations."),null),()=>{};let t=(0,a.IO)((0,a.iH)(s.Fs,"chats"),(0,a.g2)("metadata/buyerId"),(0,a.EW)(e)),n=(0,a.IO)((0,a.iH)(s.Fs,"chats"),(0,a.g2)("metadata/vendorId"),(0,a.EW)(e)),l=async e=>{let r=[];return e.forEach(e=>{let t=e.key,n=e.child("metadata").val();if(!n)return;let l=n.orderCompletedAt,i=Date.now(),d=!1;if(l){let e=new Date(l).getTime();isNaN(e)||(d=i<=e+1728e5)}if(!d)return;let o=(0,a.iH)(s.Fs,"chats/".concat(t,"/messages")),c=(0,a.IO)(o,(0,a.g2)("timestamp"),(0,a.vh)(1)),u=(0,a.U2)(c).then(e=>{let r=null,a=null;return e.forEach(e=>{let t=e.val();r=t.text,a=t.timestamp}),{id:t,...n,lastMessageText:r,lastMessageTimestamp:a}}).catch(e=>(console.error("Error fetching last message for chat ".concat(t,":"),e),{id:t,...n,lastMessageText:null,lastMessageTimestamp:null}));r.push(u)}),Promise.all(r)},i=()=>{},d=()=>{},o=null,c=null,u=null,m=null,h=!1,g=()=>{if(!h&&(null!==o||null!==u)&&(null!==c||null!==m)){h=!0;let e=null;if(u&&m?(console.error("Errors from both buyer and vendor listeners:",u,m),e=u):u?e=u:m&&(e=m),e)r(e,null);else{let e=[...new Map([...o||[],...c||[]].map(e=>[e.id,e])).values()];e.sort((e,r)=>{let t=e.lastMessageTimestamp||e.createdAt||0,a=r.lastMessageTimestamp||r.createdAt||0;return a===t?(e.id||"").localeCompare(r.id||""):a-t}),r(null,e)}}};return i=(0,a.jM)(t,async e=>{try{o=await l(e)}catch(e){console.error("Error processing buyer snapshot:",e),u=e,o=[]}g()},e=>{console.error("Error in buyer conversations listener:",e),u=e,o=[],g()}),d=(0,a.jM)(n,async e=>{try{c=await l(e)}catch(e){console.error("Error processing vendor snapshot:",e),m=e,c=[]}g()},e=>{console.error("Error in vendor conversations listener:",e),m=e,c=[],g()}),()=>{i(),d()}},l=async(e,r,t,n)=>{try{let l=(0,a.iH)(s.Fs,"chats/".concat(e,"/messages")),i=(0,a.VF)(l);return await (0,a.t8)(i,{senderId:t,recipientId:n,text:r,timestamp:(0,a.Bt)(),isRead:!1}),i.key}catch(e){throw console.error("Error adding message:",e),e}},i=(e,r)=>{try{let t=(0,a.iH)(s.Fs,"chats/".concat(e,"/messages")),n=(0,a.IO)(t,(0,a.g2)("timestamp")),l=(0,a.jM)(n,e=>{let t=[];e.forEach(e=>{t.push({id:e.key,...e.val()})}),r(t)},e=>{console.error("Error fetching messages:",e),r(null,e)});return l}catch(e){throw console.error("Error setting up message listener:",e),e}},d=async(e,r,t)=>{try{let n=(0,a.iH)(s.Fs,"chats/".concat(e,"/messages/").concat(r)),l=await (0,a.U2)(n);if(l.exists()){let e=l.val();e.recipientId===t?await (0,a.Vx)(n,{isRead:!0}):console.warn("markAsRead: currentUserId is not the recipient.")}}catch(e){throw console.error("Error marking message as read:",e),e}},o=(e,r,t)=>{try{let n=(0,a.iH)(s.Fs,"chats/".concat(e,"/messages")),l=(0,a.jM)(n,e=>{let a=0;e.forEach(e=>{let t=e.val();t.recipientId===r&&!t.isRead&&a++}),t(a)},e=>{console.error("Error fetching unread messages count:",e),t(0,e)});return l}catch(e){throw console.error("Error setting up unread messages count listener:",e),e}}}}]);
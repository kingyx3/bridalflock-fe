(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[313],{166:function(e,t,r){(window.__NEXT_P=window.__NEXT_P||[]).push(["/messages",function(){return r(6247)}])},6247:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return m}});var s=r(5893),a=r(7294),n=r(8285),o=r(1664),l=r.n(o),i=r(5130);let c=e=>{if(!e)return"";let t=new Date(e),r=new Date,s=Math.floor((r-t)/1e3);if(s<60)return"".concat(s,"s ago");let a=Math.floor(s/60);if(a<60)return"".concat(a,"m ago");let n=Math.floor(a/60);return n<24?"".concat(n,"h ago"):n<48?"Yesterday, ".concat(t.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit"})):t.toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})},u=()=>{let[e,t]=(0,a.useState)([]),[r,n]=(0,a.useState)(!0),[o,u]=(0,a.useState)(null),[d,m]=(0,a.useState)({uid:"placeholder-user-uid",name:"Current User"});return((0,a.useEffect)(()=>{if(!d||!d.uid)return u("User not authenticated."),n(!1),()=>{};n(!0);let e=(0,i.EG)(d.uid,async(e,r)=>{if(e){u(e.message),t([]),n(!1);return}let s=r.map(e=>{let t=e.buyerId===d.uid?e.vendorId:e.buyerId;return{...e,withUser:t,unreadCount:0}});t(s),u(null),n(!1),s.forEach(e=>{(0,i.v$)(e.id,d.uid,r=>{t(t=>t.map(t=>t.id===e.id?{...t,unreadCount:r}:t))})})});return()=>{e()}},[d]),r)?(0,s.jsx)("p",{children:"Loading conversations..."}):o?(0,s.jsxs)("p",{className:"text-red-500",children:["Error: ",o]}):0===e.length?(0,s.jsx)("p",{children:"No conversations yet."}):(0,s.jsx)("div",{className:"space-y-4",children:e.map(e=>(0,s.jsxs)(l(),{href:"/messages/".concat(e.id),className:"block p-4 border border-gray-200 rounded-lg hover:bg-gray-50 dark:border-neutral-medium dark:hover:bg-neutral-dark-alt transition-colors duration-150",children:[(0,s.jsxs)("div",{className:"flex justify-between items-start",children:[" ",(0,s.jsxs)("div",{className:"flex-grow min-w-0",children:[" ",(0,s.jsxs)("h3",{className:"text-md font-semibold text-neutral-dark dark:text-neutral-light ".concat(e.unreadCount>0?"font-bold":""),children:["Chat with: ",e.withUser?e.withUser.substring(0,15):"User","...",e.unreadCount>0&&(0,s.jsx)("span",{className:"ml-2 bg-red-500 text-white text-xs font-semibold px-2 py-1 rounded-full",children:e.unreadCount})]})]}),e.lastMessageTimestamp&&(0,s.jsxs)("span",{className:"text-xs text-gray-500 dark:text-neutral-medium whitespace-nowrap ml-2",children:[" ",c(e.lastMessageTimestamp)]})]}),(0,s.jsx)("p",{className:"mt-1 text-sm text-gray-600 dark:text-neutral-light truncate",children:e.lastMessageText||(e.id?"No messages yet":"Loading...")})]},e.id))})},d=()=>(0,s.jsx)(n.Z,{children:(0,s.jsxs)("div",{className:"container mx-auto px-4 py-8",children:[(0,s.jsx)("h1",{className:"text-3xl font-bold mb-8",children:"Your Conversations"}),(0,s.jsx)(u,{})," "]})});var m=d},5130:function(e,t,r){"use strict";r.d(t,{EG:function(){return n},Hz:function(){return o},_U:function(){return l},v$:function(){return c},zJ:function(){return i}});var s=r(9355),a=r(751);let n=(e,t)=>{if(!e)return t(Error("User ID is required to fetch conversations."),null),()=>{};let r=(0,s.IO)((0,s.iH)(a.Fs,"chats"),(0,s.g2)("metadata/buyerId"),(0,s.EW)(e)),n=(0,s.IO)((0,s.iH)(a.Fs,"chats"),(0,s.g2)("metadata/vendorId"),(0,s.EW)(e)),o=async e=>{let t=[];return e.forEach(e=>{let r=e.key,n=e.child("metadata").val();if(!n)return;let o=n.orderCompletedAt,l=Date.now(),i=!1;if(o){let e=new Date(o).getTime();isNaN(e)||(i=l<=e+1728e5)}if(!i)return;let c=(0,s.iH)(a.Fs,"chats/".concat(r,"/messages")),u=(0,s.IO)(c,(0,s.g2)("timestamp"),(0,s.vh)(1)),d=(0,s.U2)(u).then(e=>{let t=null,s=null;return e.forEach(e=>{let r=e.val();t=r.text,s=r.timestamp}),{id:r,...n,lastMessageText:t,lastMessageTimestamp:s}}).catch(e=>(console.error("Error fetching last message for chat ".concat(r,":"),e),{id:r,...n,lastMessageText:null,lastMessageTimestamp:null}));t.push(d)}),Promise.all(t)},l=()=>{},i=()=>{},c=null,u=null,d=null,m=null,h=!1,g=()=>{if(!h&&(null!==c||null!==d)&&(null!==u||null!==m)){h=!0;let e=null;if(d&&m?(console.error("Errors from both buyer and vendor listeners:",d,m),e=d):d?e=d:m&&(e=m),e)t(e,null);else{let e=[...new Map([...c||[],...u||[]].map(e=>[e.id,e])).values()];e.sort((e,t)=>{let r=e.lastMessageTimestamp||e.createdAt||0,s=t.lastMessageTimestamp||t.createdAt||0;return s===r?(e.id||"").localeCompare(t.id||""):s-r}),t(null,e)}}};return l=(0,s.jM)(r,async e=>{try{c=await o(e)}catch(e){console.error("Error processing buyer snapshot:",e),d=e,c=[]}g()},e=>{console.error("Error in buyer conversations listener:",e),d=e,c=[],g()}),i=(0,s.jM)(n,async e=>{try{u=await o(e)}catch(e){console.error("Error processing vendor snapshot:",e),m=e,u=[]}g()},e=>{console.error("Error in vendor conversations listener:",e),m=e,u=[],g()}),()=>{l(),i()}},o=async(e,t,r,n)=>{try{let o=(0,s.iH)(a.Fs,"chats/".concat(e,"/messages")),l=(0,s.VF)(o);return await (0,s.t8)(l,{senderId:r,recipientId:n,text:t,timestamp:(0,s.Bt)(),isRead:!1}),l.key}catch(e){throw console.error("Error adding message:",e),e}},l=(e,t)=>{try{let r=(0,s.iH)(a.Fs,"chats/".concat(e,"/messages")),n=(0,s.IO)(r,(0,s.g2)("timestamp")),o=(0,s.jM)(n,e=>{let r=[];e.forEach(e=>{r.push({id:e.key,...e.val()})}),t(r)},e=>{console.error("Error fetching messages:",e),t(null,e)});return o}catch(e){throw console.error("Error setting up message listener:",e),e}},i=async(e,t,r)=>{try{let n=(0,s.iH)(a.Fs,"chats/".concat(e,"/messages/").concat(t)),o=await (0,s.U2)(n);if(o.exists()){let e=o.val();e.recipientId===r?await (0,s.Vx)(n,{isRead:!0}):console.warn("markAsRead: currentUserId is not the recipient.")}}catch(e){throw console.error("Error marking message as read:",e),e}},c=(e,t,r)=>{try{let n=(0,s.iH)(a.Fs,"chats/".concat(e,"/messages")),o=(0,s.jM)(n,e=>{let s=0;e.forEach(e=>{let r=e.val();r.recipientId===t&&!r.isRead&&s++}),r(s)},e=>{console.error("Error fetching unread messages count:",e),r(0,e)});return o}catch(e){throw console.error("Error setting up unread messages count listener:",e),e}}}},function(e){e.O(0,[774,888,179],function(){return e(e.s=166)}),_N_E=e.O()}]);
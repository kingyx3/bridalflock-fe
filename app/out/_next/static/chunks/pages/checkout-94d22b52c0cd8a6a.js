(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[222],{5338:function(e,t,r){(window.__NEXT_P=window.__NEXT_P||[]).push(["/checkout",function(){return r(5269)}])},5269:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return f}});var a=r(5893),s=r(7294),n=r(4465),l=r(9611),i=r(751),c=r(6664),d=r(1163),o=r(1701),u=r(4698),m=r(2603),x=r(9822);function h(e){let{savePaymentMethod:t,setSavePaymentMethod:r,setupIntentClientSecret:n,userEmail:i}=e,h=(0,c.useStripe)(),g=(0,c.useElements)(),f=(0,d.useRouter)(),[{serviceData:p},b]=(0,o.C4)(),[k,y]=(0,s.useState)(i||""),[v,w]=(0,s.useState)(null),[j,N]=(0,s.useState)(null),[S,E]=(0,s.useState)(!1),[D,_]=(0,s.useState)(!1);(0,s.useEffect)(()=>{let{serviceId:e,tierId:t}=f.query;if(!e||!t){N("Service ID or Tier ID is missing in the URL.");return}let r=async()=>{if(N(null),w(null),p&&p.id===e&&p.tiers){let e=p.tiers.find(e=>e.id===t);if(e){w(e);return}N("Tier with ID ".concat(t," not found in the current service data. Attempting to fetch."))}_(!0);try{let r=await (0,l.ko)(e);if(r){if(b({type:x.J.SET_SERVICE_DATA,serviceData:r}),r.tiers){let a=r.tiers.find(e=>e.id===t);a?w(a):N("Selected tier (ID: ".concat(t,") not found for service (ID: ").concat(e,") after fetching."))}else N("No tiers found for service (ID: ".concat(e,") after fetching."))}else N("Service with ID ".concat(e," not found."))}catch(e){console.error("Error fetching service details in CheckoutForm:",e),N("Error loading service details: ".concat(e.message))}finally{_(!1)}};r()},[f.query,p,b]),(0,s.useEffect)(()=>{if(!h)return;let e=new URLSearchParams(window.location.search).get("payment_intent_client_secret");e&&h.retrievePaymentIntent(e).then(e=>{let{paymentIntent:t}=e;switch(t.status){case"succeeded":N("Payment captured successfully!");break;case"processing":N("Your payment is processing.");break;case"requires_payment_method":N("Your payment was not successful, please try again.");break;case"requires_capture":N("Payment authorized successfully! Your order is awaiting seller approval.");break;default:N("Something went wrong. Status: ".concat(t.status))}})},[h]);let P=async e=>{if(e.preventDefault(),!h||!g)return;if(E(!0),N(null),t&&n){let{error:e}=await h.confirmCardSetup(n,{payment_method:{card:g.getElement(c.PaymentElement)}});if(e){N(e.message),E(!1);return}}let{error:r}=await h.confirmPayment({elements:g,confirmParams:{return_url:"".concat(u.r.WEB_URL,"/success")}});r&&("card_error"===r.type||"validation_error"===r.type?N(r.message):N("An unexpected error occurred.")),E(!1)};return(0,a.jsxs)("div",{className:"w-full max-w-lg mx-auto",children:[v&&(0,a.jsxs)("div",{className:"mb-6 p-4 border dark:border-neutral-medium rounded-lg shadow bg-white dark:bg-neutral-dark",children:[(0,a.jsx)("h2",{className:"text-xl font-semibold text-neutral-dark dark:text-neutral-light mb-3",children:"Order Summary"}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsxs)("div",{className:"flex justify-between",children:[(0,a.jsx)("span",{className:"text-neutral-medium dark:text-neutral-light",children:"Service:"}),(0,a.jsx)("span",{className:"font-medium text-neutral-dark dark:text-neutral-light",children:(null==p?void 0:p.title)||(v?"Service Title":"")})]}),(0,a.jsxs)("div",{className:"flex justify-between",children:[(0,a.jsx)("span",{className:"text-neutral-medium dark:text-neutral-light",children:"Tier:"}),(0,a.jsx)("span",{className:"font-medium text-neutral-dark dark:text-neutral-light",children:v.tierName})]}),(0,a.jsxs)("div",{className:"flex justify-between",children:[(0,a.jsx)("span",{className:"text-neutral-medium dark:text-neutral-light",children:"Price:"}),(0,a.jsxs)("span",{className:"font-bold text-xl text-accent dark:text-accent-light",children:["S$",v.tierPrice]})]}),v.tierInclusions&&v.tierInclusions.length>0&&(0,a.jsxs)("div",{className:"pt-2",children:[(0,a.jsx)("span",{className:"text-sm text-neutral-medium dark:text-neutral-light",children:"Includes:"}),(0,a.jsx)("ul",{className:"list-disc list-inside text-sm text-neutral-dark dark:text-neutral-light",children:v.tierInclusions.slice(0,3).map(e=>(0,a.jsx)("li",{children:e.label},e.id||e.label))})]})]})]}),D&&(0,a.jsx)("div",{className:"mb-6 p-4 border dark:border-neutral-medium rounded-lg shadow bg-white dark:bg-neutral-dark text-center",children:(0,a.jsx)("p",{className:"text-neutral-medium dark:text-neutral-light",children:"Loading tier details..."})}),!D&&!v&&!j&&(0,a.jsx)("div",{className:"mb-6 p-4 border dark:border-neutral-medium rounded-lg shadow bg-white dark:bg-neutral-dark text-center",children:(0,a.jsx)("p",{className:"text-neutral-medium dark:text-neutral-light",children:"Tier details not available."})}),(0,a.jsxs)("form",{id:"payment-form",onSubmit:P,className:"w-full space-y-6 bg-white dark:bg-neutral-dark p-6 sm:p-8 rounded-lg shadow-md border dark:border-neutral-medium",children:[(0,a.jsx)(c.LinkAuthenticationElement,{id:"link-authentication-element",onChange:e=>y(e.value.email),options:{defaultValues:{email:k}}}),(0,a.jsx)(c.PaymentElement,{id:"payment-element",options:{layout:"tabs"}}),(0,a.jsxs)("div",{children:[(0,a.jsxs)("div",{className:"flex items-center",children:[(0,a.jsx)("input",{id:"save-payment-method",type:"checkbox",checked:t,onChange:e=>r(e.target.checked),className:"h-4 w-4 text-accent dark:text-accent-light border-neutral-medium dark:border-neutral-dark rounded focus:ring-accent dark:focus:ring-accent-light dark:bg-neutral-dark"}),(0,a.jsx)("label",{htmlFor:"save-payment-method",className:"ml-2 block text-sm font-medium text-neutral-dark dark:text-neutral-light",children:"Save my payment details for future purchases"})]}),(0,a.jsx)("p",{className:"mt-1 ml-6 text-xs text-neutral-medium dark:text-neutral-light",children:"For a faster checkout next time. Your card details are stored securely with Stripe."})]}),(0,a.jsxs)(m.Z,{variant:"filled",size:"lg",disabled:S||D||!h||!g||!v,onClick:P,className:"w-full font-semibold bg-accent hover:bg-pink-500 dark:hover:bg-pink-600 text-white focus:ring-pink-500 transition-colors",children:[S&&"Processing Payment...",D&&"Loading Details...",!S&&!D&&"Pay S$".concat(v?v.tierPrice:"0.00")]}),j&&(0,a.jsx)("div",{id:"payment-message",className:"mt-4 p-3 rounded-md text-sm ".concat(j.includes("succeeded")||j.includes("Payment succeeded!")?"bg-success/20 text-green-700 dark:bg-green-800/30 dark:text-success border border-success":j.includes("not successful")||j.includes("error")||j.includes("not found")||j.includes("not available")?"bg-error/20 text-red-700 dark:bg-red-800/30 dark:text-error border border-error":"bg-blue-100/80 text-blue-700 dark:bg-blue-800/30 dark:text-blue-300 border border-blue-300"),children:j})]})]})}let g=(0,n.J)(u.r.STRIPE_PK);var f=function(){let[e,t]=(0,s.useState)(""),[r,n]=(0,s.useState)(null),u=(0,d.useRouter)(),{serviceId:m,tierId:x,serviceDate:f}=u.query,[{isDarkMode:p,user:b}]=(0,o.C4)(),[k,y]=(0,s.useState)(!0),[v,w]=(0,s.useState)(f||"");return(0,s.useEffect)(()=>{if(!m||!x){console.error("Service ID or Tier ID is missing.");return}let e=async()=>{let e=i.I8.currentUser;if(e&&e.uid)try{let r={serviceId:m,tierId:x,savePaymentMethod:k,serviceDate:v,userEmail:e.email},a=await (0,l.LV)(r);a&&a.clientSecret?(t(a.clientSecret),a.setupIntentClientSecret&&n(a.setupIntentClientSecret)):console.error("Failed to create order or clientSecret missing:",a)}catch(e){console.error("Error creating order intent:",e)}else console.error("User not logged in. Cannot create order.")};v&&e()},[m,x,v,k]),(0,a.jsxs)("div",{className:"min-h-[80vh] max-w-full mx-4 sm:mx-8 md:mx-12 lg:mx-20 py-8 flex flex-col gap-8 sm:gap-10 items-center",children:[(0,a.jsx)("h1",{className:"text-2xl sm:text-3xl text-center font-semibold text-neutral-darkest dark:text-neutral-lightest",children:"Please complete the payment to place the order."}),(0,a.jsxs)("div",{className:"w-full max-w-md",children:[(0,a.jsx)("label",{htmlFor:"serviceDate",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Service Date"}),(0,a.jsx)("input",{type:"date",name:"serviceDate",id:"serviceDate",value:v,onChange:e=>w(e.target.value),min:new Date().toISOString().split("T")[0],className:"mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm text-gray-900 dark:text-gray-100",required:!0})]}),e&&v?(0,a.jsx)(c.Elements,{options:{clientSecret:e,appearance:{theme:p?"night":"stripe",variables:{colorPrimary:p?"#A78BFA":"#6D28D9",colorBackground:p?"#1F2937":"#ffffff",colorText:p?"#E5E7EB":"#1F2937",colorDanger:p?"#FCA5A5":"#DC2626"},rules:{".Input":{borderColor:p?"#4B5563":"#E5E7EB",color:p?"#F9FAFB":"#1F2937"},".Input:focus":{borderColor:p?"#C4B5FD":"#8B5CF6"},".Label":{color:p?"#D1D5DB":"#374151"}}}},stripe:g,children:(0,a.jsx)(h,{savePaymentMethod:k,setSavePaymentMethod:y,setupIntentClientSecret:r,userEmail:null==b?void 0:b.email})},e+(p?"dark":"light")):m&&x?(0,a.jsx)("p",{className:"text-neutral-medium dark:text-neutral-light",children:v?"Loading payment options...":"Please select a service date."}):(0,a.jsx)("p",{className:"text-error dark:text-red-400",children:"There was an issue loading payment details. Please check the URL or go back."})]})}}},function(e){e.O(0,[101,774,888,179],function(){return e(e.s=5338)}),_N_E=e.O()}]);